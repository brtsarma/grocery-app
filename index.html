<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grocery App PWA with Firebase</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3b82f6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  .checked { text-decoration: line-through; opacity: 0.6; filter: blur(0.5px); transition: all 0.3s ease; }
  .slider-container { overflow: hidden; width: 100%; position: relative; }
  .slider-track { display: flex; transition: transform 0.4s ease; width: 100%; }
  .store-card { min-width: 100%; max-width: 100%; box-sizing: border-box; padding: 1rem; display: flex; flex-direction: column; }
  .arrow-btn { position: absolute; top: 50%; transform: translateY(-50%); background: white; padding: 0.5rem 0.75rem; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,.2); font-size: 24px; cursor: pointer; z-index: 10; }
  .arrow-left { left: 0.5rem; }
  .arrow-right { right: 0.5rem; }
</style>
<script type="module">
  import {
    groceryRef,
    set,
    onValue,
  } from './firebase.js';
  window.firebaseRefs = {
    groceryRef,
    set,
    onValue,
  };
</script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">

<div id="root"></div>

<script type="text/babel">

function GroceryApp() {
  const {
    groceryRef,
    set,
    onValue,
  } = window.firebaseRefs;

  const defaultStoreData = {
    Winco: ["Seeds","Nuts"],
    Walmart: ["Strawberry","Blueberry","Cilantro","Bell pepper","Cucumber","Organic spinach","Iceberg cabbage","Tomatoes","Avocados","Onion","Potatoes","Garlic","Cherry tomatoes","Banana","Chicken Breast","Organic mozzarella cheese sticks","Baby Bel","Tea milk","Probiotic Yogurt","Taco Fire Sauce","Salad dressing"],
    Sams: ["Protein bar","Once upon a Farm Pouch","Salmon","Wipes","Diaper","Cottage cheese","Lance Peanut biscuit","Cauliflower","Mushroom","Capsicum","Asparagus","Iceberg cabbage","Tea Milk","Organic Milk","Organic Egg"],
    Costco: ["Fish","Aussie Bites"],
    IndiaBazar: ["Dhaniya","Thorai Packet"]
  };

  const defaultRecipeData = {
    "Smoothie": ["Banana","Strawberry","Blueberry","Probiotic Yogurt"],
    "Green Salad": ["Organic spinach","Iceberg cabbage","Cucumber","Tomatoes","Cherry tomatoes","Bell pepper","Avocados","Onion","Salad dressing"],
    "Tacos": ["Chicken Breast","Taco Fire Sauce","Cilantro","Onion"],
    "Kids Snacks": ["Seeds","Nuts","Organic mozzarella cheese sticks","Baby Bel","Once upon a Farm Pouch","Protein bar","Lance Peanut biscuit"],
    "Indian Curry": ["Dhaniya","Tomatoes","Onion","Garlic","Potatoes"]
  };

  const [storeData, setStoreData] = React.useState({});
  const [recipeData, setRecipeData] = React.useState({});
  const [masterStoreData, setMasterStoreData] = React.useState({});
  const [masterRecipeData, setMasterRecipeData] = React.useState({});
  const [newItemText, setNewItemText] = React.useState({});
  const [newStoreName, setNewStoreName] = React.useState('');
  const [newRecipeName, setNewRecipeName] = React.useState('');
  const [currentIndex, setCurrentIndex] = React.useState(0);
  const [viewMode, setViewMode] = React.useState('store'); // 'store' or 'recipe'
  const [isLoggedIn, setIsLoggedIn] = React.useState(false);
  const [loginForm, setLoginForm] = React.useState({ username: '', password: '' });
  const [loginError, setLoginError] = React.useState('');

  React.useEffect(() => {
    if (window.localStorage && window.localStorage.getItem('groceryLoggedIn') === '1') {
      setIsLoggedIn(true);
    }

    onValue(groceryRef, snapshot => {
      const val = snapshot.val() || {};

      const rawStores = val.stores || val || {};
      const rawRecipes = val.recipes || {};

      const allStoreNames = Array.from(new Set([
        ...Object.keys(defaultStoreData),
        ...Object.keys(rawStores)
      ]));

      const allRecipeNames = Array.from(new Set([
        ...Object.keys(defaultRecipeData),
        ...Object.keys(rawRecipes)
      ]));

      const loadedStores = {};
      allStoreNames.forEach(store => {
        const sourceList = rawStores[store] || defaultStoreData[store] || [];
        loadedStores[store] = sourceList.map(i =>
          typeof i === 'string' ? { name: i, checked: false } : i
        );
      });

      const loadedRecipes = {};
      allRecipeNames.forEach(recipe => {
        const sourceList = rawRecipes[recipe] || defaultRecipeData[recipe] || [];
        loadedRecipes[recipe] = sourceList.map(i =>
          typeof i === 'string' ? { name: i, checked: false } : i
        );
      });

      setStoreData(loadedStores);
      setMasterStoreData(loadedStores);
      setRecipeData(loadedRecipes);
      setMasterRecipeData(loadedRecipes);

      set(groceryRef, { stores: loadedStores, recipes: loadedRecipes });
    });
  }, []);

  const saveToFirebase = (nextStores, nextRecipes) => {
    const payload = {
      stores: nextStores || storeData,
      recipes: nextRecipes || recipeData
    };
    set(groceryRef, payload);
  };

  const handleCheck = (itemName) => {
    const newStores = { ...storeData };
    const newRecipes = { ...recipeData };

    let isCheckedSomewhere = false;

    [newStores, newRecipes].forEach(groupData => {
      Object.keys(groupData).forEach(groupName => {
        if (groupData[groupName]?.some(item => item.name === itemName && item.checked)) {
          isCheckedSomewhere = true;
        }
      });
    });

    const newChecked = !isCheckedSomewhere;

    [newStores, newRecipes].forEach(groupData => {
      Object.keys(groupData).forEach(groupName => {
        groupData[groupName] = groupData[groupName].map(item =>
          item.name === itemName ? { ...item, checked: newChecked } : item
        );
      });
    });

    setStoreData(newStores);
    setRecipeData(newRecipes);
    saveToFirebase(newStores, newRecipes);
  };

  const addItem = (groupName, text) => {
    if (!text) return;
    const newItems = text
      .split(',')
      .map(i => i.trim())
      .filter(Boolean)
      .map(i => ({ name: i, checked: false }));

    if (viewMode === 'store') {
      const newStores = { ...storeData, [groupName]: [...(storeData[groupName] || []), ...newItems] };
      const newMasterStores = { ...masterStoreData, [groupName]: [...(masterStoreData[groupName] || []), ...newItems] };
      setStoreData(newStores);
      setMasterStoreData(newMasterStores);
      setNewItemText(prev => ({ ...prev, [groupName]: '' }));
      saveToFirebase(newStores, null);
    } else {
      const newRecipes = { ...recipeData, [groupName]: [...(recipeData[groupName] || []), ...newItems] };
      const newMasterRecipes = { ...masterRecipeData, [groupName]: [...(masterRecipeData[groupName] || []), ...newItems] };
      setRecipeData(newRecipes);
      setMasterRecipeData(newMasterRecipes);
      setNewItemText(prev => ({ ...prev, [groupName]: '' }));
      saveToFirebase(null, newRecipes);
    }
  };

  const deleteItem = (itemName) => {
    const newStores = {};
    Object.keys(storeData).forEach(store => {
      newStores[store] = storeData[store].filter(item => item.name !== itemName);
    });

    const newRecipes = {};
    Object.keys(recipeData).forEach(recipe => {
      newRecipes[recipe] = recipeData[recipe].filter(item => item.name !== itemName);
    });

    setStoreData(newStores);
    setRecipeData(newRecipes);
    saveToFirebase(newStores, newRecipes);
  };

  const resetList = () => {
    const resetStores = {};
    Object.keys(masterStoreData).forEach(store => {
      resetStores[store] = masterStoreData[store].map(item => ({ ...item, checked: false }));
    });

    const resetRecipes = {};
    Object.keys(masterRecipeData).forEach(recipe => {
      resetRecipes[recipe] = masterRecipeData[recipe].map(item => ({ ...item, checked: false }));
    });

    setStoreData(resetStores);
    setRecipeData(resetRecipes);
    saveToFirebase(resetStores, resetRecipes);
  };

  const addStore = () => {
    const name = newStoreName.trim();
    if (!name || storeData[name]) return;
    const newStores = { ...storeData, [name]: [] };
    const newMasterStores = { ...masterStoreData, [name]: [] };
    setStoreData(newStores);
    setMasterStoreData(newMasterStores);
    setNewStoreName('');
    setCurrentIndex(Object.keys(newStores).length - 1);
    saveToFirebase(newStores, null);
    alert('Store added');
  };

  const addRecipeGroup = () => {
    const name = newRecipeName.trim();
    if (!name || recipeData[name]) return;
    const newRecipes = { ...recipeData, [name]: [] };
    const newMasterRecipes = { ...masterRecipeData, [name]: [] };
    setRecipeData(newRecipes);
    setMasterRecipeData(newMasterRecipes);
    setNewRecipeName('');
    setCurrentIndex(Object.keys(newRecipes).length - 1);
    saveToFirebase(null, newRecipes);
    alert('Recipe added');
  };

  const storeNames = Object.keys(storeData);
  const recipeNames = Object.keys(recipeData);
  const activeNames = viewMode === 'store' ? storeNames : recipeNames;

  const prevGroup = () => setCurrentIndex(i => Math.max(i - 1, 0));
  const nextGroup = () => setCurrentIndex(i => Math.min(i + 1, activeNames.length - 1));

  const activeData = viewMode === 'store' ? storeData : recipeData;

  const handleLoginSubmit = (e) => {
    e.preventDefault();
    const { username, password } = loginForm;
    if (username === 'admin' && password === 'grocery123') {
      setIsLoggedIn(true);
      setLoginError('');
      if (window.localStorage) {
        window.localStorage.setItem('groceryLoggedIn', '1');
      }
    } else {
      setLoginError('Invalid username or password.');
    }
  };

  const handleLogout = () => {
    setIsLoggedIn(false);
    if (window.localStorage) {
      window.localStorage.removeItem('groceryLoggedIn');
    }
  };

  if (!isLoggedIn) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100 px-4">
        <div className="bg-white rounded-2xl shadow-lg p-6 w-full max-w-sm">
          <h1 className="text-2xl font-bold mb-2 text-center">Grocery App</h1>
          <p className="text-sm text-gray-500 mb-4 text-center">Sign in with a simple username and password.</p>
          {loginError && (
            <p className="text-xs text-red-500 mb-2 text-center">
              {loginError}
            </p>
          )}
          <form onSubmit={handleLoginSubmit} className="space-y-3">
            <input
              type="text"
              placeholder="Username"
              value={loginForm.username}
              onChange={e => setLoginForm(prev => ({ ...prev, username: e.target.value }))}
              className="w-full border rounded px-3 py-2 text-sm"
            />
            <input
              type="password"
              placeholder="Password"
              value={loginForm.password}
              onChange={e => setLoginForm(prev => ({ ...prev, password: e.target.value }))}
              className="w-full border rounded px-3 py-2 text-sm"
            />
            <button
              type="submit"
              className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow text-sm"
            >
              Login
            </button>
          </form>
          <p className="mt-3 text-xs text-gray-400 text-center">
            
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-3xl mx-auto p-4">
      <div className="flex items-center justify-between mb-4 gap-3">
        <h1 className="text-3xl font-bold text-center flex-1">Grocery List</h1>
        <button
          onClick={handleLogout}
          className="ml-3 bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-full text-xs"
        >
          Logout
        </button>
      </div>

      <div className="flex justify-center mb-4 space-x-2">
        <button
          onClick={() => { setViewMode('store'); setCurrentIndex(0); }}
          className={`px-4 py-2 rounded-full text-sm font-medium shadow ${viewMode === 'store' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'}`}
        >
          Store-wise
        </button>
        <button
          onClick={() => { setViewMode('recipe'); setCurrentIndex(0); }}
          className={`px-4 py-2 rounded-full text-sm font-medium shadow ${viewMode === 'recipe' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'}`}
        >
          Recipe-wise
        </button>
      </div>

      <div className="mb-4">
        {viewMode === 'store' && (
          <div className="bg-white rounded-xl shadow p-3 flex flex-col gap-2">
            <div className="text-sm font-semibold text-gray-700">Add New Store</div>
            <div className="flex flex-col sm:flex-row gap-2">
              <input
                type="text"
                placeholder="Store name"
                value={newStoreName}
                onChange={e => setNewStoreName(e.target.value)}
                className="flex-1 border rounded px-2 py-1 text-sm"
              />
              <button
                onClick={addStore}
                className="bg-green-600 text-white px-3 py-1 rounded text-sm w-full sm:w-auto"
              >
                Add Store
              </button>
            </div>
          </div>
        )}

        {viewMode === 'recipe' && (
          <div className="bg-white rounded-xl shadow p-3 flex flex-col gap-2">
            <div className="text-sm font-semibold text-gray-700">Add New Recipe</div>
            <div className="flex flex-col sm:flex-row gap-2">
              <input
                type="text"
                placeholder="Recipe name"
                value={newRecipeName}
                onChange={e => setNewRecipeName(e.target.value)}
                className="flex-1 border rounded px-2 py-1 text-sm"
              />
              <button
                onClick={addRecipeGroup}
                className="bg-green-600 text-white px-3 py-1 rounded text-sm w-full sm:w-auto"
              >
                Add Recipe
              </button>
            </div>
          </div>
        )}
      </div>

      <button onClick={resetList} className="mb-4 bg-blue-600 text-white px-4 py-2 rounded-xl shadow">RESET LIST</button>

      <div className="slider-container relative">
        <div className="slider-track" style={{transform: `translateX(-${currentIndex*100}%)`}}>
          {activeNames.map(name => (
            <div key={name} className="store-card bg-white rounded-2xl shadow p-4">
              <h2 className="text-xl font-semibold mb-2">
                {viewMode === 'store' ? `Store: ${name}` : `Recipe: ${name}`}
              </h2>
              <div className="flex flex-wrap gap-2 mt-2">
                <input
                  type="text"
                  placeholder="Add item(s), comma separated"
                  value={newItemText[name]||''}
                  onChange={e=>setNewItemText(prev=>({...prev,[name]:e.target.value}))}
                  className="flex-1 min-w-[150px] border rounded px-2 py-1"
                />
                <button onClick={()=>addItem(name,newItemText[name])} className="bg-green-600 text-white px-3 py-1 rounded">Add</button>
              </div>
              <ul className="mt-2 space-y-2">
                {activeData[name]?.map(item => (
                  <li key={item.name} className="flex justify-between items-center">
                    <div className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={item.checked}
                        onChange={()=>handleCheck(item.name)}
                        className="h-5 w-5"
                      />
                      <span className={`text-lg ${item.checked ? 'checked' : ''}`}>{item.name}</span>
                    </div>
                    <button onClick={()=>deleteItem(item.name)} className="text-red-600 hover:text-red-800 shrink-0">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H3a1 1 0 000 2h14a1 1 0 100-2h-2V3a1 1 0 00-1-1H6zm2 5a1 1 0 011 1v7a1 1 0 11-2 0V8a1 1 0 011-1zm4 0a1 1 0 011 1v7a1 1 0 11-2 0V8a1 1 0 011-1z" clipRule="evenodd"/>
                      </svg>
                    </button>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
        <div className="arrow-btn arrow-left" onClick={prevGroup}>‹</div>
        <div className="arrow-btn arrow-right" onClick={nextGroup}>›</div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<GroceryApp />);
</script>
</body>
</html>
