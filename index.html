<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Grocery App PWA with Firebase</title>

<!-- Tailwind + Flowbite -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<link rel="stylesheet" href="https://unpkg.com/flowbite@2.5.1/dist/flowbite.min.css">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3b82f6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- FULL GLASS UI THEME -->
<style>
:root {
  --glass-bg: rgba(255, 255, 255, 0.22);
  --glass-bg-strong: rgba(255, 255, 255, 0.32);
  --glass-border: rgba(255, 255, 255, 0.35);
  --glass-shadow: 0 8px 28px rgba(0,0,0,0.22);
  --glass-radius: 1.25rem;
}

body {
  background: linear-gradient(135deg, #dbeafe, #e0e7ff, #f5f3ff);
  min-height: 100vh;
  backdrop-filter: blur(20px);
}

.checked {
  text-decoration: line-through;
  opacity: 0.5;
  filter: blur(0.6px);
  transition: all 0.25s ease;
}

/* Store/Recipe Glass Cards */
.store-card {
  min-width: 100%;
  padding: 1.25rem;
  border-radius: var(--glass-radius);
  background: var(--glass-bg);
  backdrop-filter: blur(18px);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  transition: transform 0.35s ease;
}
.store-card:hover {
  transform: translateY(-3px);
}

/* Slider */
.slider-container {
  overflow: hidden;
  width: 100%;
  position: relative;
  background: var(--glass-bg-strong);
  border-radius: var(--glass-radius);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(25px);
  box-shadow: inset 0 0 20px rgba(255,255,255,0.25);
}

.slider-track {
  display: flex;
  transition: transform 0.45s cubic-bezier(0.22,1,0.36,1);
}

/* Input Fields */
input[type="text"], input[type="password"] {
  background: rgba(255,255,255,0.25);
  border: 1px solid var(--glass-border);
  border-radius: 0.9rem;
  padding: 0.6rem 0.8rem;
  backdrop-filter: blur(12px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
}

/* Buttons */
button {
  background: rgba(255,255,255,0.25);
  border: 1px solid var(--glass-border);
  border-radius: 9999px;
  padding: 0.55rem 1.2rem;
  backdrop-filter: blur(14px);
  transition: all 0.25s ease;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  font-weight: 600;
}
button:hover {
  background: rgba(255,255,255,0.35);
  transform: translateY(-2px);
}

/* Header Glass Style */
h1 {
  background: rgba(255,255,255,0.28);
  padding: 0.6rem 1.2rem;
  border-radius: 1rem;
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  backdrop-filter: blur(15px);
}

/* Login Box Override */
.bg-white\/90 {
  background: rgba(255,255,255,0.28) !important;
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(20px);
  border-radius: 1.25rem;
  box-shadow: var(--glass-shadow);
}
</style>

<!-- Firebase Imports -->
<script type="module">
  import { groceryRef, set, onValue } from "./firebase.js";
  window.firebaseRefs = { groceryRef, set, onValue };
</script>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

</head>
<body>

<div id="root"></div>

<script type="text/babel">

/***********************
 * MAIN GROCERY APP
 ***********************/
function GroceryApp() {
  const { groceryRef, set, onValue } = window.firebaseRefs;

  /* Default Stores */
  const defaultStoreData = {
    Winco: ["Seeds","Nuts"],
    Walmart: ["Strawberry","Blueberry","Cilantro","Bell pepper","Cucumber","Organic spinach","Iceberg cabbage","Tomatoes","Avocados","Onion","Potatoes","Garlic","Cherry tomatoes","Banana","Chicken Breast","Organic mozzarella cheese sticks","Baby Bel","Tea milk","Probiotic Yogurt","Taco Fire Sauce","Salad dressing"],
    Sams: ["Protein bar","Once upon a Farm Pouch","Salmon","Wipes","Diaper","Cottage cheese","Lance Peanut biscuit","Cauliflower","Mushroom","Capsicum","Asparagus","Iceberg cabbage","Tea Milk","Organic Milk","Organic Egg"],
    Costco: ["Fish","Aussie Bites"],
    IndiaBazar: ["Dhaniya","Thorai Packet"]
  };

  /* Recipes */
  const defaultRecipeData = {
    Smoothie: ["Banana","Strawberry","Blueberry","Probiotic Yogurt"],
    "Green Salad": ["Organic spinach","Iceberg cabbage","Cucumber","Tomatoes","Cherry tomatoes","Bell pepper","Avocados","Onion","Salad dressing"],
    Tacos: ["Chicken Breast","Taco Fire Sauce","Cilantro","Onion"],
    "Kids Snacks": ["Seeds","Nuts","Organic mozzarella cheese sticks","Baby Bel","Once upon a Farm Pouch","Protein bar","Lance Peanut biscuit"],
    "Indian Curry": ["Dhaniya","Tomatoes","Onion","Garlic","Potatoes"]
  };

  /* React State */
  const [storeData, setStoreData] = React.useState({});
  const [recipeData, setRecipeData] = React.useState({});
  const [masterStoreData, setMasterStoreData] = React.useState({});
  const [masterRecipeData, setMasterRecipeData] = React.useState({});
  const [newItemText, setNewItemText] = React.useState({});
  const [newStoreName, setNewStoreName] = React.useState("");
  const [newRecipeName, setNewRecipeName] = React.useState("");
  const [currentIndex, setCurrentIndex] = React.useState(0);
  const [viewMode, setViewMode] = React.useState("store");
  const [touchStartX, setTouchStartX] = React.useState(null);
  const [touchEndX, setTouchEndX] = React.useState(null);
  const [isLoggedIn, setIsLoggedIn] = React.useState(false);
  const [loginForm, setLoginForm] = React.useState({ username: "", password: "" });
  const [loginError, setLoginError] = React.useState("");

  /**********************
   * Firebase Sync
   **********************/
  React.useEffect(() => {
    if (localStorage.getItem("groceryLoggedIn") === "1") {
      setIsLoggedIn(true);
    }

    onValue(groceryRef, snapshot => {
      const val = snapshot.val() || {};
      const rawStores = val.stores || {};
      const rawRecipes = val.recipes || {};

      const allStoreNames = [...new Set([...Object.keys(defaultStoreData), ...Object.keys(rawStores)])];
      const allRecipeNames = [...new Set([...Object.keys(defaultRecipeData), ...Object.keys(rawRecipes)])];

      const loadedStores = {};
      allStoreNames.forEach(store => {
        const source = rawStores[store] || defaultStoreData[store] || [];
        loadedStores[store] = source.map(x => (typeof x === "string" ? { name: x, checked: false } : x));
      });

      const loadedRecipes = {};
      allRecipeNames.forEach(recipe => {
        const source = rawRecipes[recipe] || defaultRecipeData[recipe] || [];
        loadedRecipes[recipe] = source.map(x => (typeof x === "string" ? { name: x, checked: false } : x));
      });

      setStoreData(loadedStores);
      setMasterStoreData(loadedStores);

      setRecipeData(loadedRecipes);
      setMasterRecipeData(loadedRecipes);

      set(groceryRef, { stores: loadedStores, recipes: loadedRecipes });
    });
  }, []);

  /**********************
   * Save to Firebase
   **********************/
  const saveToFirebase = (stores, recipes) => {
    set(groceryRef, {
      stores: stores || storeData,
      recipes: recipes || recipeData
    });
  };

  /**********************
   * Check Item
   **********************/
  const handleCheck = (name) => {
    const newStores = JSON.parse(JSON.stringify(storeData));
    const newRecipes = JSON.parse(JSON.stringify(recipeData));

    let checked = false;

    Object.values(newStores).forEach(list => list.forEach(i => { if (i.name === name && i.checked) checked = true; }));
    Object.values(newRecipes).forEach(list => list.forEach(i => { if (i.name === name && i.checked) checked = true; }));

    const newVal = !checked;

    Object.keys(newStores).forEach(s => newStores[s] = newStores[s].map(it => it.name === name ? { ...it, checked: newVal } : it));
    Object.keys(newRecipes).forEach(r => newRecipes[r] = newRecipes[r].map(it => it.name === name ? { ...it, checked: newVal } : it));

    setStoreData(newStores);
    setRecipeData(newRecipes);
    saveToFirebase(newStores, newRecipes);
  };

  /**********************
   * Add Item
   **********************/
  const addItem = (group, text) => {
    if (!text) return;

    const newItems = text.split(",").map(i => i.trim()).filter(x => x).map(x => ({ name: x, checked: false }));

    if (viewMode === "store") {
      const updatedStores = { ...storeData, [group]: [...storeData[group], ...newItems] };
      setStoreData(updatedStores);
      setMasterStoreData({ ...masterStoreData, [group]: [...masterStoreData[group], ...newItems] });
      saveToFirebase(updatedStores, null);
    } else {
      const updatedRecipes = { ...recipeData, [group]: [...recipeData[group], ...newItems] };
      setRecipeData(updatedRecipes);
      setMasterRecipeData({ ...masterRecipeData, [group]: [...masterRecipeData[group], ...newItems] });
      saveToFirebase(null, updatedRecipes);
    }

    setNewItemText(prev => ({ ...prev, [group]: "" }));
  };

  /**********************
   * Delete Item
   **********************/
  const deleteItem = (name) => {
    const updatedStores = {};
    const updatedRecipes = {};

    Object.keys(storeData).forEach(s => {
      updatedStores[s] = storeData[s].filter(i => i.name !== name);
    });
    Object.keys(recipeData).forEach(r => {
      updatedRecipes[r] = recipeData[r].filter(i => i.name !== name);
    });

    setStoreData(updatedStores);
    setRecipeData(updatedRecipes);
    saveToFirebase(updatedStores, updatedRecipes);
  };

  /**********************
   * Reset List
   **********************/
  const resetList = () => {
    const newStores = {};
    Object.keys(masterStoreData).forEach(s => newStores[s] = masterStoreData[s].map(i => ({ ...i, checked: false })));

    const newRecipes = {};
    Object.keys(masterRecipeData).forEach(r => newRecipes[r] = masterRecipeData[r].map(i => ({ ...i, checked: false })));

    setStoreData(newStores);
    setRecipeData(newRecipes);
    saveToFirebase(newStores, newRecipes);
  };

  /**********************
   * Add Store / Recipe
   **********************/
  const addStore = () => {
    if (!newStoreName.trim()) return;
    if (storeData[newStoreName]) return;

    const updatedStores = { ...storeData, [newStoreName]: [] };
    setStoreData(updatedStores);
    setMasterStoreData({ ...masterStoreData, [newStoreName]: [] });
    setNewStoreName("");
    setCurrentIndex(Object.keys(updatedStores).length - 1);
    saveToFirebase(updatedStores, null);
  };

  const addRecipeGroup = () => {
    if (!newRecipeName.trim()) return;
    if (recipeData[newRecipeName]) return;

    const updatedRecipes = { ...recipeData, [newRecipeName]: [] };
    setRecipeData(updatedRecipes);
    setMasterRecipeData({ ...masterRecipeData, [newRecipeName]: [] });
    setNewRecipeName("");
    setCurrentIndex(Object.keys(updatedRecipes).length - 1);
    saveToFirebase(null, updatedRecipes);
  };

  /**********************
   * Swipe Logic (Loop)
   **********************/
  const activeList = viewMode === "store" ? storeData : recipeData;
  const names = Object.keys(activeList);

  const nextGroup = () =>
    setCurrentIndex(i => (i + 1) % names.length);

  const prevGroup = () =>
    setCurrentIndex(i => (i - 1 + names.length) % names.length);

  const handleTouchStart = (e) => {
    setTouchStartX(e.touches[0].clientX);
    setTouchEndX(null);
  };

  const handleTouchMove = (e) => {
    setTouchEndX(e.touches[0].clientX);
  };

  const handleTouchEnd = () => {
    if (touchStartX == null || touchEndX == null) return;

    const diff = touchStartX - touchEndX;

    if (diff > 50) nextGroup();
    if (diff < -50) prevGroup();

    setTouchStartX(null);
    setTouchEndX(null);
  };

  /**********************
   * Login Logic
   **********************/
  const loginSubmit = (e) => {
    e.preventDefault();
    if (loginForm.username === "admin" && loginForm.password === "grocery123") {
      setIsLoggedIn(true);
      localStorage.setItem("groceryLoggedIn", "1");
    } else {
      setLoginError("Invalid username or password.");
    }
  };

  const logout = () => {
    setIsLoggedIn(false);
    localStorage.removeItem("groceryLoggedIn");
  };

  /**********************
   * LOGIN PAGE
   **********************/
  if (!isLoggedIn) {
    return (
      <div className="min-h-screen flex items-center justify-center px-4">
        <div className="bg-white/90 shadow-xl p-6 max-w-sm w-full">
          <h1 className="text-2xl font-bold text-center mb-3">Grocery App</h1>

          {loginError && <p className="text-red-500 text-xs text-center mb-2">{loginError}</p>}

          <form onSubmit={loginSubmit} className="space-y-3">
            <input
              type="text"
              placeholder="Username"
              value={loginForm.username}
              onChange={e => setLoginForm({ ...loginForm, username: e.target.value })}
              className="w-full"
            />

            <input
              type="password"
              placeholder="Password"
              value={loginForm.password}
              onChange={e => setLoginForm({ ...loginForm, password: e.target.value })}
              className="w-full"
            />

            <button className="w-full">Login</button>
          </form>
        </div>
      </div>
    );
  }

  /**********************
   * MAIN UI
   **********************/
  return (
    <div className="max-w-xl mx-auto p-4">

      {/* Header */}
      <div className="flex justify-between items-center mb-5">
        <h1 className="text-3xl font-bold">Grocery List</h1>
        <button onClick={logout}>Logout</button>
      </div>

      {/* Toggle Buttons */}
      <div className="flex gap-2 mb-4 justify-center">
        <button onClick={() => { setViewMode("store"); setCurrentIndex(0); }}>
          Store-wise
        </button>
        <button onClick={() => { setViewMode("recipe"); setCurrentIndex(0); }}>
          Recipe-wise
        </button>
      </div>

      {/* Add Store / Recipe */}
      <div className="mb-4">
        {viewMode === "store" ? (
          <div className="bg-white/90 p-3 rounded-xl">
            <div>Add New Store</div>
            <div className="flex gap-2 mt-2">
              <input value={newStoreName} onChange={e => setNewStoreName(e.target.value)} placeholder="Store name" className="flex-1" />
              <button onClick={addStore}>Add</button>
            </div>
          </div>
        ) : (
          <div className="bg-white/90 p-3 rounded-xl">
            <div>Add New Recipe</div>
            <div className="flex gap-2 mt-2">
              <input value={newRecipeName} onChange={e => setNewRecipeName(e.target.value)} placeholder="Recipe name" className="flex-1" />
              <button onClick={addRecipeGroup}>Add</button>
            </div>
          </div>
        )}
      </div>

      {/* RESET BUTTON */}
      <button className="w-full mb-4" onClick={resetList}>
        Reset List
      </button>

      {/* SLIDER */}
      <div
        className="slider-container"
        onTouchStart={handleTouchStart}
        onTouchMove={handleTouchMove}
        onTouchEnd={handleTouchEnd}
      >
        <div
          className="slider-track"
          style={{ transform: `translateX(-${currentIndex * 100}%)` }}
        >
          {names.map(name => (
            <div key={name} className="store-card">
              <h2 className="text-xl font-semibold mb-2">{name}</h2>

              {/* Add items */}
              <div className="flex gap-2 mb-2 flex-wrap">
                <input
                  type="text"
                  placeholder="Add items"
                  value={newItemText[name] || ""}
                  onChange={e => setNewItemText(prev => ({ ...prev, [name]: e.target.value }))}
                  className="flex-1 min-w-[140px]"
                />
                <button onClick={() => addItem(name, newItemText[name])}>Add</button>
              </div>

              {/* Items */}
              <ul className="space-y-2">
                {activeList[name]?.map(item => (
                  <li key={item.name} className="flex justify-between items-center">
                    <label className="flex items-center gap-2">
                      <input type="checkbox" checked={item.checked} onChange={() => handleCheck(item.name)} />
                      <span className={item.checked ? "checked" : ""}>{item.name}</span>
                    </label>
                    <button onClick={() => deleteItem(item.name)}>âœ•</button>
                  </li>
                ))}
              </ul>

            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<GroceryApp />);

</script>

</body>
</html>
