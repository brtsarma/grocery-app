<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grocery App PWA with Firebase</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    .fade-collapse {
      transition: opacity 0.3s ease, max-height 0.3s ease, margin 0.3s ease, padding 0.3s ease;
      overflow: hidden;
    }
    .collapsed {
      opacity: 0;
      max-height: 0;
      margin: 0;
      padding: 0;
    }
  </style>

  <!-- Firebase module import -->
  <script type="module">
    import { groceryRef, set, onValue } from './firebase.js';
    window.firebaseRefs = { groceryRef, set, onValue };
  </script>
</head>
<body class="bg-gray-100 p-4">
  <div id="root"></div>

  <script type="text/babel">
    function GroceryApp() {
      const { groceryRef, set, onValue } = window.firebaseRefs;

      const defaultData = {
        Winco: ["Seeds", "Nuts"],
        Walmart: ["Strawberry","Blueberry","Cilantro","Bell pepper","Cucumber","Organic spinach","Iceberg cabbage","Tomatoes","Avocados","Onion","Potatoes","Garlic","Cherry tomatoes","Banana","Chicken Breast","Organic mozzarella cheese sticks","Baby Bel","Tea milk","Probiotic Yogurt","Taco Fire Sauce","Salad dressing"],
        Sams: [],
        Costco: ["Fish", "Aussie Bites"],
        IndiaBazar: ["Dhaniya", "Thorai Packet"],
      };

      const [masterData, setMasterDataState] = React.useState(defaultData);
      const [items, setItems] = React.useState(defaultData);
      const [pendingRemove, setPendingRemove] = React.useState({});
      const [undoQueue, setUndoQueue] = React.useState([]);
      const [newItemText, setNewItemText] = React.useState({});

      // Load from Firebase and initialize if empty
      React.useEffect(() => {
        onValue(groceryRef, (snapshot) => {
          const data = snapshot.val();
          if (data) {
            setItems(data.items || defaultData);
            setMasterDataState(data.masterData || defaultData);
          } else {
            // Initialize Firebase with default data if empty
            set(groceryRef, { items: defaultData, masterData: defaultData })
              .then(() => console.log('Firebase initialized with default data'))
              .catch(err => console.error('Firebase init error:', err));
          }
        });
      }, []);

      const saveToFirebase = (newItems, newMaster) => {
        set(groceryRef, { items: newItems, masterData: newMaster })
          .then(() => console.log('Saved to Firebase'))
          .catch(err => console.error('Firebase save error:', err));
      };

      const handleCheck = (store, item) => {
        setPendingRemove(prev => ({ ...prev, [store]: [...(prev[store] || []), item] }));
        setUndoQueue(prev => [...prev, { store, item }]);
        setTimeout(() => {
          const newItems = { ...items, [store]: items[store].filter(i => i !== item) };
          setItems(newItems);
          const newPending = { ...pendingRemove, [store]: (pendingRemove[store] || []).filter(i => i !== item) };
          setPendingRemove(newPending);
          setUndoQueue(prev => prev.filter(q => q.item !== item || q.store !== store));
          saveToFirebase(newItems, masterData);
        }, 30000);
      };

      const undoCheck = (store, item) => {
        const newPending = { ...pendingRemove, [store]: (pendingRemove[store] || []).filter(i => i !== item) };
        setPendingRemove(newPending);
        setUndoQueue(prev => prev.filter(q => q.item !== item || q.store !== store));
      };

      const undoAll = () => undoQueue.forEach(q => undoCheck(q.store, q.item));

      const resetList = () => {
        setItems(masterData);
        setPendingRemove({});
        setUndoQueue([]);
        saveToFirebase(masterData, masterData);
      };

      const addItem = (store, text) => {
        const newItemsArr = text.split(',').map(i => i.trim()).filter(Boolean);
        if (newItemsArr.length === 0) return;
        const newItems = { ...items, [store]: [...items[store], ...newItemsArr] };
        const newMaster = { ...masterData, [store]: [...masterData[store], ...newItemsArr] };
        setItems(newItems);
        setMasterDataState(newMaster);
        setNewItemText(prev => ({ ...prev, [store]: '' }));
        saveToFirebase(newItems, newMaster);
      };

      return (
        <div className="max-w-3xl mx-auto p-4">
          <h1 className="text-3xl font-bold mb-4 text-center">Grocery List (Store Wise)</h1>
          {undoQueue.length > 0 && (
            <div className="mb-4 bg-yellow-100 p-3 rounded-lg flex justify-between items-center">
              <span>Item{undoQueue.length > 1 ? 's' : ''} checked. Undo?</span>
              <button onClick={undoAll} className="ml-4 text-blue-600 underline">Undo All</button>
            </div>
          )}
          <button onClick={resetList} className="mb-6 bg-blue-600 text-white px-4 py-2 rounded-xl shadow">RESET LIST</button>
          <div className="grid grid-cols-1 gap-4">
            {Object.keys(items).map(store => (
              <div key={store} className="bg-white rounded-2xl shadow p-4">
                <h2 className="text-xl font-semibold mb-2">{store}</h2>
                <div className="flex mt-2 gap-2">
                  <input type="text" placeholder="Add item(s), comma separated" value={newItemText[store] || ''} onChange={e => setNewItemText(prev => ({ ...prev, [store]: e.target.value }))} className="border rounded px-2 py-1 flex-1" />
                  <button onClick={() => addItem(store, newItemText[store])} className="bg-green-600 text-white px-3 py-1 rounded">Add</button>
                </div>
                {items[store].length === 0 && <p className="text-gray-500 mt-2">All checked!</p>}
                <ul className="space-y-2 mt-2">
                  {items[store].map(item => {
                    const isPending = (pendingRemove[store] || []).includes(item);
                    return (
                      <li key={item} className={`flex items-center gap-3 fade-collapse ${isPending ? 'collapsed' : ''}`}>
                        <input type="checkbox" onChange={() => handleCheck(store, item)} className="h-5 w-5" />
                        <span className="text-lg">{item}</span>
                        {isPending && <button onClick={() => undoCheck(store, item)} className="ml-auto text-sm text-blue-600 underline">Undo</button>}
                      </li>
                    );
                  })}
                </ul>
              </div>
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<GroceryApp />);
  </script>
</body>
</html>
